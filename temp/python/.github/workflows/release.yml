name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  id-token: write

env:
  PYTHON_VERSION: "3.11"

jobs:
  # 更新版本号
  update-version:
    name: Update Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Update version in files
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          
          # 更新 pyproject.toml 中的版本（如果使用 pyproject.toml）
          if [ -f "pyproject.toml" ]; then
            sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          fi
          
          # 更新 setup.py 中的版本（如果使用 setup.py）
          if [ -f "setup.py" ]; then
            sed -i "s/version=['\"][^'\"]*['\"]/version='$VERSION'/" setup.py
          fi
          
          # 更新 __version__ 在 __init__.py 中（根据项目结构调整路径）
          if [ -f "src/__init__.py" ]; then
            sed -i "s/__version__ = ['\"][^'\"]*['\"]/__version__ = '$VERSION'/" src/__init__.py
          fi
          
          # 或者在其他位置
          find . -name "__init__.py" -type f -exec sed -i "s/__version__ = ['\"][^'\"]*['\"]/__version__ = '$VERSION'/" {} \;
      
      - name: Commit version changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: bump version to ${{ steps.get_version.outputs.version }}" || echo "No changes to commit"
          git push origin HEAD:main || echo "Failed to push, continuing..."

  # 构建分发包
  build:
    name: Build Distribution
    needs: update-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: python -m build
      
      - name: Check package
        run: twine check dist/*
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/

  # 构建多平台二进制（使用 PyInstaller）
  build-binaries:
    name: Build Binary - ${{ matrix.os }}
    needs: update-version
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x86_64
          
          - os: ubuntu-latest
            target: linux-aarch64
            cross: true
          
          - os: macos-latest
            target: macos-x86_64
          
          - os: windows-latest
            target: windows-x86_64
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyinstaller
      
      - name: Set up QEMU (for ARM cross-compilation)
        if: matrix.cross
        uses: docker/setup-qemu-action@v3
      
      - name: Build binary (Linux ARM64)
        if: matrix.cross
        run: |
          # 使用 Docker 进行交叉编译
          docker run --rm -v $(pwd):/workspace -w /workspace \
            --platform linux/arm64 \
            python:3.11-slim bash -c "
              apt-get update && apt-get install -y gcc && \
              pip install --upgrade pip && \
              pip install -e . && \
              pip install pyinstaller && \
              pyinstaller --onefile --name YOUR_APP_NAME YOUR_MAIN_SCRIPT.py
            "
          mkdir -p dist-binary
          mv dist/* dist-binary/
      
      - name: Build binary (Other platforms)
        if: ${{ !matrix.cross }}
        run: |
          # 构建单文件可执行文件
          # 请根据项目调整入口脚本名称
          pyinstaller --onefile --name YOUR_APP_NAME YOUR_MAIN_SCRIPT.py
          
          # 或者如果有多个入口点
          # pyinstaller --onefile --name app1 script1.py
          # pyinstaller --onefile --name app2 script2.py
      
      - name: Package binary
        run: |
          mkdir -p artifacts
          cd dist
          
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Windows: 创建 zip
            7z a ../artifacts/YOUR_APP_NAME-${{ needs.update-version.outputs.version }}-${{ matrix.target }}.zip *
          else
            # Linux/macOS: 创建 tar.gz
            tar czf ../artifacts/YOUR_APP_NAME-${{ needs.update-version.outputs.version }}-${{ matrix.target }}.tar.gz *
          fi
        shell: bash
      
      - name: Upload binary artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.target }}
          path: artifacts/*

  # 创建 GitHub Release
  release:
    name: Create GitHub Release
    needs: [update-version, build, build-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f -exec cp {} release-assets/ \;
          ls -lah release-assets/
      
      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${{ needs.update-version.outputs.version }}
          
          # 获取上一个 tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "## What's Changed" > changelog.md
          echo "" >> changelog.md
          
          if [ -n "$PREV_TAG" ]; then
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" >> changelog.md
          else
            git log --pretty=format:"- %s (%h)" >> changelog.md
          fi
          
          echo "" >> changelog.md
          echo "" >> changelog.md
          echo "## Installation" >> changelog.md
          echo "" >> changelog.md
          echo "### PyPI" >> changelog.md
          echo '```bash' >> changelog.md
          echo "pip install YOUR_PACKAGE_NAME==$VERSION" >> changelog.md
          echo '```' >> changelog.md
          echo "" >> changelog.md
          echo "### Binaries" >> changelog.md
          echo "" >> changelog.md
          ls release-assets/*.tar.gz release-assets/*.zip 2>/dev/null | while read file; do
            basename_file=$(basename "$file")
            echo "- \`$basename_file\`" >> changelog.md
          done
          
          cat changelog.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          body_path: changelog.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # 发布到 PyPI（使用 Trusted Publishing）
  publish-pypi:
    name: Publish to PyPI
    needs: [update-version, build]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/project/YOUR_PACKAGE_NAME/
    permissions:
      id-token: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-packages
          path: dist/
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # 使用 Trusted Publishing，不需要 API token
          # 需要在 PyPI 项目设置中配置 Trusted Publisher
          packages-dir: dist/
